<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title></title>

    <base href="">

    
    <meta name="description" content="Welcome to Massimo Ronca website. I am a full stack developer, and definitely a tech enthusiast. This is about what I do."/>
    

    <link rel="stylesheet" href="/assets/stylesheets/fonts.css">
    <link rel="stylesheet" href="/assets/stylesheets/styles.css">
    <link rel="stylesheet" href="/assets/stylesheets/highlight/solarized-dark.css">
    <link rel="stylesheet" href="/assets/stylesheets/gist/line-number-fix.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <link rel="icon" type="image/png" href="/assets/images/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header-title"><a href="/">Massimo Ronca</a></h1>

        <img src="/assets/images/massimoronca.png" class="logo">
        <p>This is not</p>
        <p>the programmer</p>
        <p>you're looking for</p>

     <footer>
       <a href="https://github.com/wstucco" title="Github"><img src="/assets/images/github-64.png" alt="Github" class="github-logo"> </a>
       <a href="https://twitter.com/wstucco" title="Twitter"><img src="/assets/images/twitter-64.png" alt="Twitter" class="twitter-logo"> </a>
       <a href="https://it.linkedin.com/in/massimoronca" title="Linkedin"><img src="/assets/images/linkedin-64.png" alt="Linkedin" class="linkedin-logo"> </a>
      </footer>
    </header>


  <section>
  <article id="content" class="post">
  <h1 class="post-title">Writing custom commands for Drush: the Drupal swiss army knife.</h1>
  <div class="post-content">
    <p>Recently I worked on a client project based on the Drupal platform.<br />
The most important part of the job was automating a data import from a remote source, but instead of writing a script to do the job, I created a command for <a href="https://github.com/drush-ops/drush">Drush</a>.
Quoting from Drush repository site</p>

<blockquote>
<p>Drush is a command-line shell and scripting interface for Drupal, a veritable Swiss Army knife designed to make life easier for those who spend their working hours hacking away at the command prompt.</p>
</blockquote>

<p>Drush can handle almost every aspect of a Drupal site, from the mundane <a href="http://www.drushcommands.com/drush-7x/cache">cache management</a> to
<a href="http://www.drushcommands.com/drush-6x/user">user management</a>, from <a href="http://www.drushcommands.com/drush-6x/make">packaging a Drupal install into a makefile</a> to
<a href="http://www.drushcommands.com/drush-6x/pm">project management</a> and much more, including a <a href="http://www.drushcommands.com/drush-6x/sql/sql-cli">CLI for running sql queries</a> an <a href="http://www.drushcommands.com/drush-6x/runserver/runserver">http server for development</a> and an <a href="http://www.drushcommands.com/drush-7x/core/core-rsync">rsync wrapper</a>.<br />
Drush commands can also be executed on remote machines, provided Drush is installed, by specifing the server <a href="http://deeson-online.co.uk/labs/drupal-drush-aliases-and-how-use-them">alias</a> (e.g. <code>drush clear-cache @staging</code>).</p>

<p>There are different ways of creating Drush scripts:</p>

<ul>
<li>prepending the script with the shebang <code>#!/usr/bin/env drush</code> or <code>#!/full/path/to/drush</code> and using
<a href="http://www.drushcommands.com/">Drush commands</a></li>
<li>using Drush php interpreter <code>#!/full/path/to/drush php-script</code> and using the <a href="http://api.drush.org/">Drush
PHP api</a></li>
<li>writing custom commands</li>
</ul>

<p>This guide is about the last case.<br />
Drush commands are much like Rake or Grunt tasks, you give them a name (more like a namespace) and Drush figures out what function must be called.
To create a Drush command, follow these simple steps</p>

<ul>
<li>create a <code>namespace.drush.inc</code> in one of the standard import path</li>
<li>implement the <code>namespace_drush_command</code> entry point function</li>
<li>implement the command functions. By conventions the command functions are called <code>drush_namespace_commandname</code></li>
</ul>

<p>Drush search for commandfiles in the following locations:</p>

<ul>
<li><code>/path/to/drush/commands</code> folder</li>
<li>system-wide drush commands folder, e.g. <code>/usr/share/drush/commands</code></li>
<li>.drush folder in <code>$HOME</code> folder.</li>
<li><code>sites/all/drush</code> in the current Drupal installation</li>
<li>all enabled modules folders in the current Drupal installation</li>
</ul>

<p>##Implementing the command</p>

<p>To implement a Drush command, the script must implement the drush_command hook.
This function must return a data structure containing all the informations that define your custom command.<br />
As an example we will develop a command that rolls a dice and prints the result.<br />
We&rsquo;ll use <code>diceroller</code> as namespace and <code>roll-dice</code> as command name.<br />
This is the implementation of the main hook function</p>

<pre><code class="language-php">&lt;?php
function diceroller_drush_command() {
  $items = array();

  $items['roll-dice'] = array(
    'description' =&gt; &quot;Roll a dice for your pleasure.&quot;,
    'arguments' =&gt; array(
      'faces' =&gt; 'How many faces the dice has? Default is 6, max is 100.',
    ),
    'options' =&gt; array(
      'rolls' =&gt; 'How many times the dice is rolled, default is 1 max is 100',
    ),
    'examples' =&gt; array(
      'drush drrd 6 --rolls=2' =&gt; 'Rolls a 6 faced dice 2 times',
    ),
    'aliases' =&gt; array('drrd'),
    'bootstrap' =&gt; DRUSH_BOOTSTRAP_DRUSH,
    // see http://drush.ws/docs/bootstrap.html for detailed informations
    // about the bootstrap values
  );

  return $items;
}
</code></pre>

<p>The command is easily implementd this way</p>

<pre><code class="language-php">&lt;?php

function drush_diceroller_roll_dice($faces=6) {
  $rolls = 1;

  if ($tmp = drush_get_option('rolls')) {
    $rolls = $tmp;
  }  

  drush_print(dt('Rolling a !faces faced dice !n time(s)', array(
    '!faces' =&gt; $faces,
    '!n' =&gt; $rolls
  )));
  // for n=0..$rolls
    // roll the nth dice
    // print the result
}

</code></pre>

<p>In this case we assume that the <code>--rolls</code> option contains a number, but we can guarantee that the function parameters are valid implementing the <code>validate</code> hook (there are others called just before and after the real command function).</p>

<pre><code class="language-php">&lt;?php

function drush_diceroller_roll_dice_validate($faces=6) {

  if($faces &lt;= 0) {
    return drush_set_error('DICE_WITH_NO_FACES', dt('Cannot roll a dice with no faces!'));
  }
  if($faces &gt; 100) {
    return drush_set_error('DICE_WITH_TOO_MANY_FACES', dt('Cannot roll a sphere!'));
  }

  $rolls = drush_get_option('rolls');
  if(isset($rolls)) {
    if(!is_numeric($rolls))
      return drush_set_error('ROLLS_MUST_BE_INT', dt('rolls value must be a number!'));

    if($rolls &lt;= 0)
      return drush_set_error('NOT_ENOUGH_ROLLS', dt('What you\'re asking cannot be done!'));

    if($rolls &gt; 100)
      return drush_set_error('TOO_MANY_ROLLS', dt('I\'m not your slave, roll it by yourself!'));
  }

}
</code></pre>

<p>If we did our job diligently, running <code>drush help roll-dice</code> should give us this ouput</p>

<pre><code class="language-sh">Roll a dice for your pleasure.

Examples:
 drush drrd 6 --rolls=2                    Rolls a 6 faced dice 2 times

Arguments:
 faces                                     How many faces the dice has? Default is 6, max is 100.

Options:
 --rolls                                   How many times the dice is rolled, default is 1 max is 100

Aliases: drrd
</code></pre>

<p>Consult the <a href="http://api.drush.org/">Drush api</a> for a complete list of hooks <a href="http://api.drush.org/api/drush/functions/6.x">functions</a> and <a href="http://api.drush.org/api/drush/constants/6.x">constants</a> or launch <code>drush topic docs-api</code> from the command line.<br />
For a complete implementation of a command example, see <code>drush topic docs-examplecommand</code>.</p>

  </div>
  <div class='small post-meta'>
    posted 
    in <a href="http://dev.mikamai.com/post/85715381049/writing-custom-commands-for-drush-the-drupal-swiss">MIKAMAYHEM</a>
    
    on Wednesday, May 14 2014
  </div>
</article>

  </section>


    </div>
    <script src="/assets/javascripts/scale.fix.js"></script>
    <script src="/assets/javascripts/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1218157-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>