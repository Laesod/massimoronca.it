<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title></title>

    <base href="">

    
    <meta name="description" content="Welcome to Massimo Ronca website. I am a full stack developer, and definitely a tech enthusiast. This is about what I do."/>
    

    <link rel="stylesheet" href="/assets/stylesheets/fonts.css">
    <link rel="stylesheet" href="/assets/stylesheets/styles.css">
    <link rel="stylesheet" href="/assets/stylesheets/highlight/solarized-dark.css">
    <link rel="stylesheet" href="/assets/stylesheets/gist/line-number-fix.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <link rel="icon" type="image/png" href="/assets/images/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header-title"><a href="/">Massimo Ronca</a></h1>

        <img src="/assets/images/massimoronca.png" class="logo" alt="Massimo Ronca">
        <p>This is not</p>
        <p>the programmer</p>
        <p>you're looking for</p>

     <footer>
       <a href="https://github.com/wstucco" title="Github"><img src="/assets/images/github-64.png" alt="Github" class="github-logo"> </a>
       <a href="https://twitter.com/wstucco" title="Twitter"><img src="/assets/images/twitter-64.png" alt="Twitter" class="twitter-logo"> </a>
       <a href="https://it.linkedin.com/in/massimoronca" title="Linkedin"><img src="/assets/images/linkedin-64.png" alt="Linkedin" class="linkedin-logo"> </a>
      </footer>
    </header>


  <section>
  <article id="content" class="post">
  <h1 class="post-title">Start running your own DNS server</h1>
  <div class="post-content">
    <p>A common problem in web development is simulating the final environment and, specifically, running your apps in their own private domain.<br />
One solution is editing the <code>/etc/hosts</code> every time you need to add a new domain, but this can quickly become a very tedious process.<br />
If you work on OS X, you probably have heard of <a href="http://pow.cx/">Pow</a>, but if you only need the domain resolution and don&rsquo;t use Rails, it is probaly overkill to install a full featured application server just to create some dev domain.
<a href="http://www.mamp.info/en/mamp-pro/index.html?utm_medium=twitter&amp;utm_source=twitterfeed">MAMP Pro</a> offers domain resolution too, but it&rsquo;s not free.</p>

<p>There is, however, another solution: running your own instance of a DNS server.<br />
What you need it&rsquo;s a copy of <a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a> and <em>stop worrying and love the shell.</em>.</p>

<p>First of all install dnsmasq and put it in autostart</p>

<pre><code class="language-bash">brew install dnsmasq  
sudo cp -v $(brew --prefix dnsmasq)/*.plist /Library/LaunchDaemons
</code></pre>

<p>Configure the dns intance</p>

<pre><code class="language-bash">cat &lt;&lt;- EOF &gt; $(brew --prefix)/etc/dnsmasq.conf
# IPV4
address=/dev/127.0.0.1
# IPV6, otherwise virtual hosts in Maverick won't work
address=/dev/::1
listen-address=127.0.0.1
EOF
</code></pre>

<p>Then we configure the resolvers for all domains and create the one for the <code>.dev</code> suffixes</p>

<pre><code class="language-bash">sudo mkdir -p /etc/resolver
# .dev domains
sudo bash -c 'echo &quot;nameserver 127.0.0.1&quot; &gt; /etc/resolver/dev'
# universal catcher
sudo bash -c 'echo &quot;nameserver 127.0.0.1&quot; &gt; /etc/resolver/catchall'
sudo bash -c 'echo &quot;domain .&quot; &gt;&gt; /etc/resolver/catchall'
</code></pre>

<p>Set localhost as main DNS server, unfortunately you can&rsquo;t automatically prepend localhost to the list of DNSs your DHCP assigned to you.<br />
You have to change it manually and put 127.0.0.1 on top of the list.</p>

<pre><code class="language-bash">networksetup -setdnsservers Ethernet 127.0.0.1
networksetup -setdnsservers Wi-Fi 127.0.0.1
</code></pre>

<p>If everything&rsquo;s ok, running <code>scutil --dns</code> should return something like this</p>

<pre><code class="language-bash">resolver #8
domain   : dev
nameserver[0] : 127.0.0.1
flags    : Request A records, Request AAAA records
reach    : Reachable,Local Address
</code></pre>

<p>Now you can start dnsmasq</p>

<pre><code class="language-bash"># start dnsmasq
sudo launchctl -w load /Library/LaunchDaemons/homebrew.mxcl.dnsmasq.plist

# make some tests
$ ping -c 1 anyhostname.dev
PING anyhostname.dev (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.058 ms

$ dig anyhostname.dev
;; ANSWER SECTION:
anyhostname.dev.	0	IN	A	127.0.0.1
;; Query time: 3 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)


$ dig google-public-dns-a.google.com @127.0.0.1
;; ANSWER SECTION:
google-public-dns-a.google.com.	25451 IN A	8.8.8.8
;; Query time: 30 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)

# cache will speedup subsequent DNS queries
$ dig google-public-dns-a.google.com @127.0.0.1
;; Query time: 0 msec
</code></pre>

<p>Bonus: if you run Apache on your dev machine, you can easily setup the <em>one virtual host to rule them all</em> through <a href="http://httpd.apache.org/docs/2.4/vhosts/mass.html">mass vistrual hosting</a>.</p>

<p>Edit <code>/etc/apache2/extra/httpd-vhosts.conf</code> and add this configuration, every <code>.dev</code> domain will point to a folder with the same name, but without the extension, in <code>~/Sites</code> folder.<br />
For example, <code>myapp.dev</code> will point to <code>~/Sites/myapp</code>.</p>

<pre><code class="language-apache">&lt;VirtualHost *:80&gt;
    ServerAdmin you@localhost
    ServerName anyhostname.dev
    ServerAlias *.dev

    UseCanonicalName Off
    # %1.0 is the domain without the extension, in this case
    # everything before .dev
    # more info: http://httpd.apache.org/docs/2.4/mod/mod_vhost_alias.html
    VirtualDocumentRoot /Users/[your_login]/Sites/%1.0
    ErrorLog &quot;/var/log/apache2/dev_hosts_error_log&quot;
    CustomLog &quot;/var/log/apache2/dev_hosts_access_log&quot; common

    &lt;Directory /Users/[your_login]/Sites/*&gt;
        AllowOverride All
    &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>You can finally reload Apache configuration with <code>sudo apachectl graceful</code>.</p>

  </div>
  <div class='small post-meta'>
    posted 
    in <a href="http://dev.mikamai.com/post/76415968842/start-running-your-own-dns">MIKAMAYHEM</a>
    
    on Monday, Feb 10 2014
  </div>
</article>

  </section>


    </div>
    <script src="/assets/javascripts/scale.fix.js"></script>
    <script src="/assets/javascripts/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1218157-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>