<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Massimo Ronca ~ a reckless programmer with a sarcastic wit - Taming the processing loop</title>

    <base href="http://massimoronca.it">

    
    <meta name="description" content="Welcome to Massimo Ronca website, this post is about: Processing, Non conventional interfaces, State machines, Java interfaces">
    

    <link rel="stylesheet" href="/assets/stylesheets/fonts.css">
    <link rel="stylesheet" href="/assets/stylesheets/styles.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/solarized_dark.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

    <link href="" rel="alternate" type="application/rss+xml" title="Massimo Ronca ~ a reckless programmer with a sarcastic wit" />

    <link rel="icon" type="image/png" href="/assets/images/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    

    <meta name="og:title" content="Taming the processing loop">
    <meta name="og:type" content="website">
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header-title"><a href="/">Massimo Ronca</a></h1>

        <img src="/assets/images/massimoronca.png" class="logo" alt="Massimo Ronca">
        <p>This is not</p>
        <p>the programmer</p>
        <p>you're looking for</p>

     <footer>
       <a href="https://github.com/wstucco" title="Github"><img src="/assets/images/github-64.png" alt="Github" class="github-logo"> </a>
       <a href="https://twitter.com/wstucco" title="Twitter"><img src="/assets/images/twitter-64.png" alt="Twitter" class="twitter-logo"> </a>
       <a href="https://it.linkedin.com/in/massimoronca" title="Linkedin"><img src="/assets/images/linkedin-64.png" alt="Linkedin" class="linkedin-logo"> </a>
      </footer>
    </header>


  <section>
  <article id="content" class="post">
  <h1 class="post-title">Taming the processing loop</h1>
  <div class="post-content">
    <p>In Mikamai we do a lot of reasearch on <a href="http://dev.mikamai.com/post/78652180658/how-to-program-an-attiny85-or-attiny45-with-an">non</a> <a href="http://dev.mikamai.com/post/78453410376/let-your-raspberry-pi-see-this-wonderful-world">conventional</a> <a href="http://dev.mikamai.com/post/69163914657/intel-galileo-getting-started-with-mac-os-x">hardware</a>, we make <a href="http://dev.mikamai.com/post/76945627390/you-cant-touch-this-an-evil-arduino-based-alarm">prototypes</a> or create unsual interfaces that are very domain specific.</p>

<p>Like this one</p>

<p><img src="https://scontent-b-ams.xx.fbcdn.net/hphotos-ash3/t1.0-9/994503_10151525258526336_667825845_n.jpg" alt="image" /></p>

<p>Seriously, we did it.</p>

<p>To quickly sketch ideas, we often rely on <a href="http://www.processing.org/">Processing</a>, it&rsquo;s super easy and its loop based execution model gives the feeling of programming a video game.<br />
The drawback is that it is so fast to get something working, that you will be tempted to make the mistake of creating a <a href="http://foxdellfolio.com/the-perils-of-a-polished-prototype/">polished prototpe</a>.<br />
Your prototype code ends up in production and there&rsquo;s no way back from there.</p>

<p>To resist the temptation of releasing a blob of code, I borrowed <a href="https://www.youtube.com/watch?v=HxaD_trXwRE">a technique from  one of the Rob Pike&rsquo;s talks</a> to keep things easy, while keeping them clean at the same time.</p>

<p>It is basically an implementation of a state machime.<br />
We&rsquo;re gonna have a <code>StateMachine</code> class that handles the inputs and the state changes, and several state classes that implement the <code>State</code> interface.<br />
The interface is very simple and contains only one method</p>

<pre><code class="language-java">interface State {
	  public State nextState();  
}
</code></pre>

<p>The loop of our Processing application is really simple too</p>

<pre><code class="language-java">StateMachine sm = new StateMachine(initialstate);
void draw() {
  sm = sm.nextState();  
}
</code></pre>

<p>and this is the most basic implementation possible of the <code>StateMachine</code> class</p>

<pre><code class="language-java">class StateMachine(State initialstate) {
  private State currentstate;

  StateMachine(State initialstate) {
    this.currentstate = initialstate;
  }

  public StateMachine nextState() {
    this.currentstate = this.currentstate.nextState();
   	return this;
  }
}
</code></pre>

<p>Each class must implement the <code>nextState</code> method and return an istance of the next state that will be executed.<br />
With this knowledge in mind, this is how you build an infinite loop inside an inifinite loop</p>

<pre><code class="language-java">class InfiniteLoopState implements State {
	public State nextState() {
	    return this;
  	}
}
</code></pre>

<p>But we can do better!<br />
How about a ping pong?</p>

<pre><code class="language-java">class Ping implements State {
	public State nextState() {
		println(&quot;ping?&quot;);
	    return new PongState();
  	}
}

class Pong implements State {
	public State nextState() {
		println(&quot;pong!&quot;);
	    return new PingState();
  	}
}
</code></pre>

<p>We moved the logic of the application out of the central <code>switch/case</code> statement in the <code>draw</code> function and deconstruted it into smaller pieces, that only know about themselves and the next state they are going to emit.</p>

<p>As long as your state classes implement the <code>State</code> interface you can exapnd the concept to fit your needs.<br />
For example, if you need to keep track of the environment and/or the previous state, you can adjust the <code>State</code> interface to support it.</p>

<pre><code class="language-java">interface State {
	  public State nextState(State previousstate, StateMachine sm);  
	  // StateMachine holds the environment for us
}
</code></pre>

<p>and modify <code>StateMachine</code> accordingly</p>

<pre><code class="language-java">public StateMachine nextState() {
  this.currentstate = this.currentstate.nextState(this.currentstate, this);
 	return this;
}
</code></pre>

<p><strong>TL;DR:</strong> state machines are easy, use them!</p>

<p>You can find examples on how to use this pattern and how to add more features in the <a href="https://github.com/wstucco/processing_state_machine">github repository</a>.</p>

  </div>
  <div class='small post-meta'>
    posted 
    in <a href="http://dev.mikamai.com/post/82178345433/taming-the-processing-loop">MIKAMAYHEM</a>
    
    on Wednesday, Apr 9 2014
  </div>
</article>

  </section>


    </div>
    <script src="/assets/javascripts/scale.fix.js"></script>
    <script src="/assets/javascripts/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1218157-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    
    <script type="text/javascript" charset="UTF-8" src="http://chs02.cookie-script.com/s/64f1a8ad4d34d91e16260247ae88d42f.js"></script>
    
  </body>
</html>