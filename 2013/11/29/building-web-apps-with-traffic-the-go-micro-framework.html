<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Building web apps with Traffic, the Go micro framework.</title>

    <link rel="stylesheet" href="/assets/stylesheets/fonts.css">
    <link rel="stylesheet" href="/assets/stylesheets/styles.css">
    <link rel="stylesheet" href="/assets/stylesheets/pygment_trac.css">

    <link rel="icon" type="image/png" href="/assets/images/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header-title"><a href="/">Massimo Ronca</a></h1>

        <img src="/assets/images/massimoronca.png" class="logo">
        <p>This is not</p>
        <p>the programmer</p>
        <p>you're looking for</p>

        <nav>
          <ul>
            <li><a href="/about.html">ABOUT</a></li>
          </ul>
        </nav>
    </header>
      <section>
      <article>
	<h1 class="post-title">Building web apps with Traffic, the Go micro framework.</h1>
	<div class="post-content">
	<p>Written by the long time Ruby developer <a href="http://gravityblast.com/">Andrea Franz</a>,  <a href="https://github.com/pilu/traffic/"><strong>Traffic</strong></a> is a <a href="http://flask.pocoo.org/docs/foreword/#what-does-micro-mean"><em>micro framework</em></a> for Web development inspired by <a href="http://www.sinatrarb.com">Sinatra</a>.    </p>

<p>In times when software development is moving towards creating services for other applications, micro frameworks serve very well this paradigm by providing an easy way to create the building blocks, such as a REST API, on top of which larger applications can rely.  </p>

<p>Micro frameworks do not cover every single aspect of application building, most of them are left to the developer, for example you decide which database to use and how to access it or not to use a DB at all, but the codebase is so compact that a single person can master it in a matter of few days.</p>

<p>Like other popular frameworks, <em>Traffic</em> features include</p>

<ul>
<li>regexp routing </li>
<li>chainable request filters</li>
<li>middlewares</li>
<li>templates</li>
<li>serving of static files</li>
<li>custom error handlers</li>
<li>facilities to render in various format (HTML, JSON and XML)</li>
<li>errors and stacktraces in the browser</li>
<li>command line utility to generate new projects (although very basic)</li>
</ul>

<p>Documentation is a little bit scarce at the moment, but there are many <a href="https://github.com/pilu/traffic/blob/master/examples/">examples</a> that make it easy to figure out how to use the various components.</p>

<p>We are going to analyze each one of them, by writing a small demo application, a simple clone of the placehold.it service powered by the Grumpy cat, instead of gray boxes.<br>
As usual, code is available on <a href="https://github.com/wstucco/purrraceholder">github</a>.</p>

<h3>Installing Traffic</h3>

<p>Assuming you already have a working installation of Go, download Traffic   </p>
<div class="highlight"><pre><code class="bash"><a name="line-1"></a><span class="nv">$ </span>go get github.com/pilu/traffic
</code></pre></div>
<p>and the command line tool  </p>
<div class="highlight"><pre><code class="bash"><a name="line-1"></a><span class="nv">$ </span>go get github.com/pilu/traffic/traffic
</code></pre></div>
<p>create a new project</p>
<div class="highlight"><pre><code class="bash"><a name="line-1"></a><span class="nv">$ </span>traffic new demo_project
</code></pre></div>
<p>run it</p>
<div class="highlight"><pre><code class="bash"><a name="line-1"></a><span class="nv">$ </span><span class="nb">cd </span>demo_project  
<a name="line-2"></a><span class="nv">$ </span>go build <span class="o">&amp;&amp;</span> ./demo_project
</code></pre></div>
<p>and point your browser to <a href="http://127.0.0.1:7000/">http://127.0.0.1:7000/</a></p>

<h3>Routing</h3>

<p>The first thing we need for our application is a router.<br>
Traffic routes are a pair of an HTTP method and a URL pattern that, if matched,<br>
call a function that act as route-handler.  </p>

<p>Our first route </p>
<div class="highlight"><pre><code class="go"><a name="line-1"></a><span class="kn">package</span> <span class="nx">main</span>
<a name="line-2"></a>
<a name="line-3"></a><span class="kn">import</span> <span class="p">(</span>
<a name="line-4"></a>    <span class="s">&quot;github.com/pilu/traffic&quot;</span>
<a name="line-5"></a><span class="p">)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class="kd">var</span> <span class="nx">router</span> <span class="o">*</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">Router</span>
<a name="line-8"></a>
<a name="line-9"></a><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
<a name="line-10"></a>    <span class="nx">router</span> <span class="p">=</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
<a name="line-11"></a>    <span class="nx">router</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">RootHandler</span><span class="p">)</span>
<a name="line-12"></a>    <span class="nx">router</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
<a name="line-13"></a><span class="p">}</span>   
</code></pre></div>
<p>Routes are matched in the same order they are declared, the first that match is executed.  </p>

<p>Routes can contain named parameters that are accesible using the <code class="inline-code">Param</code> function.  </p>
<div class="highlight"><pre><code class="go"><a name="line-1"></a><span class="nx">router</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">`/:width/:height/?`</span><span class="p">,</span> <span class="nx">ImageHandler</span><span class="p">)</span>
<a name="line-2"></a>
<a name="line-3"></a><span class="kd">func</span> <span class="nx">ImageHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<a name="line-4"></a>    <span class="nx">width</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Param</span><span class="p">(</span><span class="s">&quot;width&quot;</span><span class="p">)</span>
<a name="line-5"></a>    <span class="nx">height</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Param</span><span class="p">(</span><span class="s">&quot;height&quot;</span><span class="p">)</span>
<a name="line-6"></a><span class="p">}</span>
</code></pre></div>
<p>and parameters can be optional</p>
<div class="highlight"><pre><code class="go"><a name="line-1"></a><span class="nx">router</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">`/:width)/(:height)?`</span><span class="p">,</span> <span class="nx">ImageHandler</span><span class="p">)</span>
</code></pre></div>
<p>Route patterns can also include wildcards and regular expressions</p>
<div class="highlight"><pre><code class="go"><a name="line-1"></a><span class="nx">router</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">`/:width/*`</span><span class="p">,</span> <span class="nx">ImageHandler</span><span class="p">)</span>
<a name="line-2"></a>
<a name="line-3"></a><span class="c1">// match (width)x(height) format</span>
<a name="line-4"></a><span class="nx">router</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">`/(?P&lt;width&gt;\d+)(x(?P&lt;height&gt;\d+)?)?/?`</span><span class="p">,</span> <span class="nx">ImageHandler</span><span class="p">)</span>
</code></pre></div>
<h3>Before filters</h3>

<p>Traffic allows to prepend the request handler with filters, which are like regular request handlers that get executed before the real handler.<br>
Before fitlers can be chained and can be attached to all routes or just some of them.<br>
If a before filters write something in the Response Body, the request chain is interrupted.  </p>
<div class="highlight"><pre><code class="go"><a name="line-1"></a><span class="c1">// if route match, before executing ImageHandler, Traffic executes the two filters</span>
<a name="line-2"></a><span class="c1">// RequireValidImageParameters and GenerateImageCache in order  </span>
<a name="line-3"></a><span class="c1">// If one of them fails and write to the response body, the execution stops</span>
<a name="line-4"></a><span class="c1">// before reaching the actual handler</span>
<a name="line-5"></a><span class="nx">router</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">`/:width/?(:height)?/?`</span><span class="p">,</span> <span class="nx">ImageHandler</span><span class="p">).</span>
<a name="line-6"></a>    <span class="nx">AddBeforeFilter</span><span class="p">(</span><span class="nx">RequireValidImageParameters</span><span class="p">).</span>
<a name="line-7"></a>    <span class="nx">AddBeforeFilter</span><span class="p">(</span><span class="nx">GenerateImageCache</span><span class="p">)</span>
<a name="line-8"></a>
<a name="line-9"></a><span class="kd">func</span> <span class="nx">RequireValidImageParameters</span><span class="p">(</span><span class="nx">w</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<a name="line-10"></a>    <span class="nx">width</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Param</span><span class="p">(</span><span class="s">&quot;width&quot;</span><span class="p">))</span> 
<a name="line-11"></a>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// conversion error, either var is empty or not a number</span>
<a name="line-12"></a>        <span class="c1">// cannot continue</span>
<a name="line-13"></a>        <span class="nx">w</span><span class="p">.</span><span class="nx">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">)</span> 
<a name="line-14"></a>        <span class="k">return</span>
<a name="line-15"></a>    <span class="p">}</span>
<a name="line-16"></a>
<a name="line-17"></a>    <span class="nx">height</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Param</span><span class="p">(</span><span class="s">&quot;height&quot;</span><span class="p">))</span>
<a name="line-18"></a>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<a name="line-19"></a>        <span class="c1">// if height is omitted the image is gonna be a square</span>
<a name="line-20"></a>        <span class="nx">height</span> <span class="p">=</span> <span class="nx">width</span> 
<a name="line-21"></a>    <span class="p">}</span>
<a name="line-22"></a>
<a name="line-23"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">width</span> <span class="o">&lt;=</span> <span class="mi">2560</span> <span class="o">&amp;&amp;</span> <span class="nx">width</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">height</span> <span class="o">&lt;=</span> <span class="mi">2560</span> <span class="o">&amp;&amp;</span> <span class="nx">height</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="line-24"></a>        <span class="c1">// set vars for the next filter</span>
<a name="line-25"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-26"></a>        <span class="c1">// bad request</span>
<a name="line-27"></a>        <span class="nx">w</span><span class="p">.</span><span class="nx">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
<a name="line-28"></a>        <span class="nx">w</span><span class="p">.</span><span class="nx">Render</span><span class="p">(</span><span class="s">&quot;400&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<a name="line-29"></a>    <span class="p">}</span>
<a name="line-30"></a><span class="p">}</span>   
<a name="line-31"></a>
<a name="line-32"></a><span class="kd">func</span> <span class="nx">GenerateImageCache</span><span class="p">(</span><span class="nx">w</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<a name="line-33"></a>    <span class="c1">// pseudo code  </span>
<a name="line-34"></a>    <span class="k">if</span> <span class="nx">not</span> <span class="nx">cache_folder_exists</span> <span class="nx">and</span> <span class="nx">create_folder_fails</span>
<a name="line-35"></a>        <span class="nx">throw</span> <span class="kt">error</span> <span class="nx">with</span> <span class="nx">panic</span>
<a name="line-36"></a>
<a name="line-37"></a>    <span class="nx">write_image_file_according_to_parameters</span>
<a name="line-38"></a><span class="p">}</span>
<a name="line-39"></a>
<a name="line-40"></a><span class="kd">func</span> <span class="nx">ImageHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<a name="line-41"></a>    <span class="c1">// output the image with the correct content-type</span>
<a name="line-42"></a>    <span class="nx">w</span><span class="p">.</span><span class="nx">Header</span><span class="p">().</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;image/jpeg&quot;</span><span class="p">)</span>
<a name="line-43"></a>
<a name="line-44"></a>    <span class="c1">// at this point we can safely assume that the image file already exists</span>
<a name="line-45"></a><span class="p">}</span>
<a name="line-46"></a>
<a name="line-47"></a><span class="c1">// this filter is global to the router and is applied before each request</span>
<a name="line-48"></a><span class="nx">router</span><span class="p">.</span><span class="nx">AddBeforeFilter</span><span class="p">(</span><span class="nx">PoweredByHandler</span><span class="p">)</span>
<a name="line-49"></a>
<a name="line-50"></a><span class="kd">func</span> <span class="nx">PoweredByHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<a name="line-51"></a>    <span class="nx">w</span><span class="p">.</span><span class="nx">Header</span><span class="p">().</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;X-Powered-By&quot;</span><span class="p">,</span> <span class="s">&quot;Grumpy cat&quot;</span><span class="p">)</span>
<a name="line-52"></a><span class="p">}</span>
</code></pre></div>
<h3>Templates and static files</h3>

<p>Traffic supports templates in the standard Go format.<br>
Template library documentation can be found <a href="http://golang.org/pkg/html/template/">here</a>.<br>
Traffic Response Writer has a method to render templates called <code class="inline-code">Render</code>, that takes the template name (without the extension) and an optional param that contains the data to be rendered.<br>
By default templates are placed in the <code class="inline-code">/view</code> folder.<br>
Templates can be nested one isnide the other like in our <code class="inline-code">404</code> example</p>
<div class="highlight"><pre><code class="django"><a name="line-1"></a><span class="cp">{{</span> <span class="nv">template</span> <span class="s2">&quot;includes/header&quot;</span> <span class="cp">}}</span><span class="x"></span>
<a name="line-2"></a><span class="x">    &lt;div class=&quot;error error-404&quot;&gt;&lt;/div&gt;</span>
<a name="line-3"></a><span class="cp">{{</span> <span class="nv">template</span> <span class="s2">&quot;includes/footer&quot;</span> <span class="cp">}}</span><span class="x"></span>
</code></pre></div>
<p>If you are writing an API you might find the methods <code class="inline-code">WriteJSON</code> and <code class="inline-code">WriteXML</code> useful too.   </p>

<p>Traffic also support serving static assets: every file placed in the <code class="inline-code">/public</code> folder is directly accessible.<br>
For example if we put a css inside <code class="inline-code">/public/css/app.css</code> it will be automatically accessible as 
<code class="inline-code">http://address/css/app.css</code>.  </p>

<p><strong>Update</strong>:  static files are served through <code class="inline-code">StaticMiddleware</code> that is added automatically only if environment is <em>‘development’</em>.
Environment is set using the <code class="inline-code">TRAFFIC_ENV</code> variable, so if you set it to<code class="inline-code">production</code>, you have to manually add the <code class="inline-code">StaticMiddleware</code>  </p>
<div class="highlight"><pre><code class="go"><a name="line-1"></a><span class="k">if</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">Env</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;production&quot;</span> <span class="p">{</span>
<a name="line-2"></a>    <span class="nx">router</span><span class="p">.</span><span class="nx">Use</span><span class="p">(</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">NewStaticMiddleware</span><span class="p">(</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">PublicPath</span><span class="p">()))</span>
<a name="line-3"></a><span class="p">}</span>
</code></pre></div>
<h3>Custom error handlers</h3>

<p>The Traffic router has builtin handlers for <code class="inline-code">404</code> and <code class="inline-code">500</code> erros that can be customized.</p>
<div class="highlight"><pre><code class="go"><a name="line-1"></a><span class="c1">// Custom not found handler</span>
<a name="line-2"></a><span class="nx">router</span><span class="p">.</span><span class="nx">NotFoundHandler</span> <span class="p">=</span> <span class="nx">NotFoundHandler</span>
<a name="line-3"></a>
<a name="line-4"></a><span class="kd">func</span> <span class="nx">NotFoundHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<a name="line-5"></a>    <span class="nx">w</span><span class="p">.</span><span class="nx">Render</span><span class="p">(</span><span class="s">&quot;404&quot;</span><span class="p">)</span>
<a name="line-6"></a><span class="p">}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class="c1">// Custom error handler</span>
<a name="line-9"></a><span class="nx">router</span><span class="p">.</span><span class="nx">ErrorHandler</span> <span class="p">=</span> <span class="nx">ErrorHandler</span>
<a name="line-10"></a>
<a name="line-11"></a><span class="kd">func</span> <span class="nx">ErrorHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">traffic</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">traffic</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
<a name="line-12"></a>    <span class="nx">w</span><span class="p">.</span><span class="nx">Render</span><span class="p">(</span><span class="s">&quot;500&quot;</span><span class="p">)</span>
<a name="line-13"></a><span class="p">}</span>
</code></pre></div>
<h3>Conclusions</h3>

<p><a href="https://github.com/pilu/traffic/">Traffic</a> is a young framework specifically crafte for small to medium applications.<br>
I was able to create the demo app <a href="https://github.com/wstucco/purrraceholder">Purrraceholder</a> (read it with a japanese accent) in a couple of hours, without previous knowledge of Traffic internals.<br>
I know there are people that can write a blog in 15 minutes, but I think hours is a more realistic time frame and, most of all, you are really in control of what&#39;s happening.<br>
If you wanna play with <a href="https://github.com/pilu/traffic/">Traffic</a>, you can start by forking <a href="https://github.com/wstucco/purrraceholder">Purraceholder</a> and adding some features.<br>
These are the firsts that come to mind:  </p>

<ul>
<li>add more cats, there are never enough cats on the internet</li>
<li>treat special cases with special cats: longcat for vertical images, monorail cat for horizontal ones</li>
<li>add support for text overlay</li>
</ul>

<p>happy coding with <a href="https://github.com/pilu/traffic/">Traffic</a>.</p>

	</div>
	<div class='small post-meta'>posted in <a href="http://dev.mikamai.com/post/68453619468/building-web-apps-with-traffic-the-go-micro-framework">MIKAMAYHEM</a> on Friday, 29 November 2013</div>
</article>


      </section>
      <footer>
        <p class="view">                    
          <img src="/assets/images/GitHub-Mark-32px.png" alt="" class="github-logo">
          <a href="https://github.com/wstucco">my GitHub profile</a>
        </p>
      </footer>
    </div>
    <script src="/assets/javascripts/scale.fix.js"></script>
    
		<script type="text/javascript">

		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-1218157-1']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();

		</script>    
  </body>
</html>
